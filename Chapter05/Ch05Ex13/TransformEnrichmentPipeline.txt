---DROP Tables Script activity
IF OBJECT_ID (N'brainwaves.FactREADING', N'U') IS NOT NULL
 DROP TABLE [brainwaves].[FactREADING]
IF OBJECT_ID (N'brainwaves.SCENARIO_FREQUENCY', N'U') IS NOT NULL
 DROP TABLE [brainwaves].[SCENARIO_FREQUENCY]

---SETUP Staging Script activity
IF OBJECT_ID (N'staging.TmpREADING', N'U') IS NOT NULL
 DELETE FROM [staging].[TmpREADING]
ELSE
  CREATE TABLE [staging].[TmpREADING]
  ( 
    [READING_ID] [int]  NOT NULL,
    [SESSION_ID] [int]  NOT NULL,
    [ELECTRODE_ID] [int]  NOT NULL,
    [FREQUENCY_ID] [int]  NOT NULL,
    [READING_DATETIME] [datetime]  NOT NULL,
    [COUNT] [int]  NOT NULL,
    [VALUE] [decimal](8,3)  NOT NULL
  )
  WITH
  (
	DISTRIBUTION = ROUND_ROBIN,
	CLUSTERED COLUMNSTORE INDEX
  )
---REMOVE Outliers Data flow
VALUE > 0.274 && VALUE < 392

---FactREADING Script activity
CREATE TABLE [brainwaves].[FactREADING]
  WITH
  (
    CLUSTERED COLUMNSTORE INDEX,
    DISTRIBUTION = HASH ([FREQUENCY])
  )
    AS
    SELECT  se.SESSION_DATETIME, r.READING_DATETIME, 
            s.SCENARIO, e.ELECTRODE, f.FREQUENCY, r.[VALUE]
    FROM    [brainwaves].[DimSESSION] se, [staging].[TmpREADING] r, 
            [brainwaves].[DimSCENARIO] s, [brainwaves].[DimELECTRODE] e, 
            [brainwaves].[DimFREQUENCY] f
    WHERE   r.SESSION_ID = se.SESSION_ID AND se.SCENARIO_ID = s.SCENARIO_ID 
            AND r.ELECTRODE_ID = e.ELECTRODE_ID AND r.FREQUENCY_ID = f.FREQUENCY_ID

-----Notebook - Ch05Ex13TB
%%spark
val df = spark.read.sqlanalytics("SQLPool.brainwaves.FactREADING") 
df.write.mode("overwrite").parquet("abfss://brainjammer@csharpguitar.dfs.core.windows.net/EMEA/brainjammer/in/2022/05/19/14/transformedBrainwavesV1.parquet")
